@{
    ViewData["Title"] = "Mis Solicitudes";
    var solicitudes = ViewBag.Solicitudes as List<Viajes.Models.DTO.SolicitudDTO> ?? new List<Viajes.Models.DTO.SolicitudDTO>();
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold text-primary">
                <i class="bi bi-file-earmark-text me-2"></i>Mis Solicitudes de Viaje
            </h2>
            <p class="text-muted">Crea y gestiona tus solicitudes de viaje</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaSolicitud">
                <i class="bi bi-plus-circle me-2"></i>Nueva Solicitud
            </button>
            <button type="button" class="btn btn-warning ms-2" id="btnAgregarGasto" style="display:none;">
                <i class="bi bi-plus-circle me-2"></i>Agregar Gasto
            </button>
            <!-- Campo oculto para guardar el ID de la solicitud pendiente -->
            <input type="hidden" id="IdSolicitudViajeHidden"
                   value="@solicitudes.FirstOrDefault(s => s.IdEstado == 3)?.IdSolicitudViaje" />

        

        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-3" id="estadoTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-estado="todos" href="#">Todos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-estado="pendiente" href="#">Pendientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-estado="aprobado" href="#">Aprobados</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-estado="rechazado" href="#">Rechazados</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-estado="cerrada" href="#">Cerradas</a>
                </li>
            </ul>

            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Historial de Solicitudes</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Destino</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                    <th>Presupuesto</th>
                                    <th>Estado</th>
                                    <th>Fecha Creación</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (solicitudes.Count > 0)
                                {
                                    foreach (var solicitud in solicitudes)
                                    {
                                        var estadoClass = solicitud.IdEstado switch
                                        {
                                            3 => "warning",   // Pendiente
                                            4 => "success",   // Aprobado
                                            5 => "danger",    // Rechazado
                                            6 => "secondary", // Cerrada
                                            _ => "secondary"
                                        };
                                        var estadoTexto = solicitud.IdEstado switch
                                        {
                                            3 => "Pendiente",
                                            4 => "Aprobado",
                                            5 => "Rechazado",
                                            6 => "Cerrada",
                                            _ => "Desconocido"
                                        };

                                        <tr>
                                            <td>@solicitud.IdSolicitudViaje</td>
                                            <td>@solicitud.Destino</td>
                                            <td>@solicitud.FechaInicioViaje.ToString("dd/MM/yyyy")</td>
                                            <td>@solicitud.FechaFinViaje.ToString("dd/MM/yyyy")</td>
                                            <td>@solicitud.PresupuestoEstimado.ToString("C")</td>
                                            <td>
                                                <span class="badge bg-@estadoClass">@estadoTexto</span>
                                                @if (solicitud.IdEstado == 4)
                                                {
                                                    <div class="mt-2">
                                                        <button class="btn btn-outline-primary btnJustificar" data-id="@solicitud.IdSolicitudViaje">
                                                            Justificar gastos
                                                        </button>
                                                    </div>
                                                }
                                            </td>
                                            <td>@solicitud.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            No tienes solicitudes registradas.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="modalNuevaSolicitud" tabindex="-1" aria-labelledby="modalNuevaSolicitudLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalNuevaSolicitudLabel">
                    <i class="bi bi-file-earmark-plus me-2"></i>Nueva Solicitud de Viaje
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formNuevaSolicitud">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="Destino" class="form-label">Destino <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="Destino" name="Destino" required placeholder="Ej: Ciudad de Panamá, Panamá">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="FechaInicioViaje" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="FechaInicioViaje" name="FechaInicioViaje" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="FechaFinViaje" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="FechaFinViaje" name="FechaFinViaje" required>
                        </div>
                    </div> 
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="Motivo" class="form-label">Motivo del Viaje <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="Motivo" name="Motivo" rows="4" required placeholder="Describe el motivo del viaje..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-2"></i>Crear Solicitud
                    </button>
                   

                </div>
            </form>
        </div>
    </div>
</div>

@Html.Partial("~/Views/Gastos/_AgregarGasto.cshtml")




@section Scripts {
    <script>
        $(document).ready(function () {
            var modalSolicitud = new bootstrap.Modal(document.getElementById("modalNuevaSolicitud"));
            var modalGasto = new bootstrap.Modal(document.getElementById("modalAgregarGasto"));

            // --- FILTRAR SOLICITUDES POR ESTADO ---
                           function cargarSolicitudesPorEstado(estado) {
            $.getJSON('/GestionSolicitudes/ObtenerSolicitudesPorEstado', { estado: estado }, function (response) {
                var tbody = $('.card-body table tbody');
                tbody.empty();

                console.log("Respuesta completa del backend:", response);

                if (response.success && Array.isArray(response.data) && response.data.length > 0) {
                    response.data.forEach(function (sol, index) {
                        //Depuración: ver cada objeto recibido
                        console.log("Solicitud #" + index, sol);

                        let estadoClass = "secondary";
                        let estadoTexto = sol.estadoNombre ?? "Desconocido";

                        switch (sol.idEstado) {
                            case 3: estadoClass = "warning"; break;
                            case 4: estadoClass = "success"; break;
                            case 5: estadoClass = "danger"; break;
                            case 6: estadoClass = "secondary"; break;
                            case 7: estadoClass = "secondary"; break;
                        }

                        let fila = `
                            <tr>
                                <td>${sol.idSolicitudViaje ?? ''}</td>
                                <td>${sol.destino ?? ''}</td>
                                <td>${sol.fechaInicioViaje ?? ''}</td>
                                <td>${sol.fechaFinViaje ?? ''}</td>
                                <td>${sol.presupuestoEstimado ? parseFloat(sol.presupuestoEstimado).toLocaleString('es-NI', { style: 'currency', currency: 'NIO' }) : 'C$0.00'}</td>
                                <td>
                                    <span class="badge bg-${estadoClass}">${estadoTexto}</span>
                                    ${sol.idEstado === 4 ? `
                                        <div class="mt-2">
                                            <button class="btn btn-outline-primary btnJustificar" data-id="${sol.idSolicitudViaje}">
                                                Justificar gastos
                                            </button>
                                        </div>` : ''}
                                </td>
                                <td>${sol.fechaCreacion ?? ''}</td>
                            </tr>`;

                        //Depuración: ver la fila generada
                        console.log("Fila generada:", fila);

                        // Insertar en la tabla
                        tbody.append(fila);
                    });
                } else if (response.success && Array.isArray(response.data) && response.data.length === 0) {
                    console.log("No hay solicitudes para este estado");
                    tbody.html(`
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                No tienes solicitudes registradas con este estado.
                            </td>
                        </tr>
                    `);
                } else {
                    alert(response.message);
                }
            });
            }
                    // --- Mostrar botón Agregar Gasto si hay solicitudes pendientes
        function verificarSolicitudesPendientes() {
            $.getJSON('/GestionSolicitudes/ObtenerSolicitudesPorEstado', { estado: 'pendiente' }, function (response) {
                if (response.success && Array.isArray(response.data) && response.data.length > 0) {
                    $('#btnAgregarGasto').show();
                }
            });
        }

        // Llamar al cargar la página
        verificarSolicitudesPendientes();



            // --- MANEJO DE PESTAÑAS ---
            $('#estadoTabs .nav-link').on('click', function (e) {
                e.preventDefault();
                $('#estadoTabs .nav-link').removeClass('active');
                $(this).addClass('active');
                let estado = $(this).data('estado');
                console.log("Pestaña clickeada:", estado); //Depuración
                cargarSolicitudesPorEstado(estado);
            });

            // --- REDIRECCIÓN AL JUSTIFICAR GASTOS ---
            $(document).on('click', '.btnJustificar', function () {
                let idSolicitud = $(this).data('id');
                window.location.href = `/Gastos/JustificarGastos?idSolicitud=${idSolicitud}`;
            });

                  $('#formNuevaSolicitud').on('submit', function (e) {
                e.preventDefault();

                var fechaInicioStr = $('#FechaInicioViaje').val();
                var fechaFinStr = $('#FechaFinViaje').val();

                if (fechaFinStr < fechaInicioStr) {
                    alert('La fecha de fin debe ser posterior a la fecha de inicio.');
                    return;
                }

                var hoy = new Date().toISOString().split('T')[0];
                if (fechaInicioStr < hoy) {
                    alert('La fecha de inicio no puede ser en el pasado.');
                    return;
                }

                var destino = $('#Destino').val().trim();
                var motivo = $('#Motivo').val().trim();

                if (!destino) {
                    alert('El campo Destino es requerido.');
                    $('#Destino').focus();
                    return;
                }

                if (!motivo) {
                    alert('El campo Motivo es requerido.');
                    $('#Motivo').focus();
                    return;
                }

                var formData = {
                    Destino: destino,
                    Motivo: motivo,
                    FechaInicioViaje: fechaInicioStr,
                    FechaFinViaje: fechaFinStr
                };

                $.ajax({
                    url: '@Url.Action("CrearSolicitud", "GestionSolicitudes")',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            $('#IdSolicitudViajeHidden').val(response.idSolicitud);
                            $('#btnAgregarGasto').show();
                            $('#modalNuevaSolicitud').modal('hide');
                            cargarTiposGasto();
                            $('#modalAgregarGasto').modal('show');
                            $('#formNuevaSolicitud')[0].reset();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error al procesar la solicitud. Por favor, intente nuevamente.');
                    }
                });
            });

            // --- AGREGAR GASTO ---
            function cargarTiposGasto() {
                $.getJSON('/Gastos/ObtenerTiposGasto', function (data) {
                    var select = $('#tipoGasto');
                    select.empty();
                    select.append('<option value="">Seleccione...</option>');
                    data.forEach(function (item) {
                        select.append(`<option value="${item.value}">${item.text}</option>`);
                    });
                });
            }

            $('#btnAgregarGasto').on('click', function () {
                cargarTiposGasto();
                $('#modalAgregarGasto').modal('show'); 
            });

            $('#btnRegresarSolicitud').on('click', function () {
                var idSolicitud = $('#IdSolicitudViajeHidden').val();
                $.getJSON('/Gastos/VerificarGastos', { idSolicitud: idSolicitud }, function (data) {
                    if (data.tieneGastos) {
                        $('#modalAgregarGasto').modal('hide');
                    } else {
                        alert('Debe registrar al menos un gasto antes de salir.');
                    }
                });
            });

            $('#formAgregarGasto').on('submit', function (e) {
                e.preventDefault();

                var monto = parseFloat($('#montoGasto').val());
                if (isNaN(monto) || monto <= 0) {
                    alert('El monto debe ser mayor a 0.');
                    $('#montoGasto').focus();
                    return;
                }

                var gastoData = {
                    IdSolicitudViaje: $('#IdSolicitudViajeHidden').val(),
                    IdTipoGasto: $('#tipoGasto').val(),
                    DescripcionGasto: $('#descripcionGasto').val(),
                    MontoGasto: monto
                };

                $.ajax({
                    url: '@Url.Action("AgregarGasto", "Gastos")',
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(gastoData),
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            $('#modalAgregarGasto').modal('hide'); 
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Error al procesar el gasto. Por favor, intente nuevamente.');
                    }
                });
            });

            // --- Restricciones de fechas ---
            var hoy = new Date().toISOString().split('T')[0];
            $('#FechaInicioViaje').attr('min', hoy);
            $('#FechaFinViaje').attr('min', hoy);
        });
    </script>
}


